<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Embedded Player</title>
</head>
<body>

<span id="player-full"></span>

<script src="{{ url_for('static', filename='js/jquery.min.js') }}"></script>
<script src="//cdn.jsdelivr.net/lodash/latest/lodash.min.js"></script>
<script src="//cdn.jsdelivr.net/clappr/latest/clappr.min.js"></script>
<script src="//cdn.jsdelivr.net/clappr.thumbnails-plugin/latest/clappr-thumbnails-plugin.js"></script>
<script src="{{ url_for('static', filename='js/clappr-playback-rate-plugin.min.js') }}"></script>
<script>

    var video_obj = "{{ video_obj }}";
    var img_obj   = "{{ img_obj }}";

    var linkBuilder = function (ipfs_hash, resource) {
        return "{{ ipfs_url }}/ipfs/" + ipfs_hash + "/" + resource;
    };

    var getContent = function () {

        var thumbnailsSprite = function () {

            // first, we need to find the tilesheet
            var fileNames = _.map(extractFiles(video_obj['files']), function (o) {
                return o['Name'];
            });
            var spriteFileName = _.first(
                _.filter(fileNames, function (filename) {
                    return /tilesheet_.*\.png/.test(filename)
                })
            );
            if (!spriteFileName) {
                return []
            }

            var properties = _.tail(spriteFileName.split('.')[0].split('_'));
            var numThumbnails = properties[0];
            var timeInterval = properties[1];
            var tileWidth = properties[2];
            var tileHeight = properties[3];

            return ClapprThumbnailsPlugin.buildSpriteConfig(
                linkBuilder(video_obj['root'], spriteFileName),
                numThumbnails,  // number of thumbnails
                tileWidth, // thumbnail width
                tileHeight, // thumbnail height
                10, // number of tiles (columns) per row
                timeInterval // time interval
            );
        };

        var player = new Clappr.Player({
            source: linkBuilder(video_obj['root'], video_obj['video_file']),
            poster: linkBuilder(img_obj['root'], 'large.png?'),
            mute: false,
            height: window.innerHeight-20,
            width: "100%",
            autoPlay: {{ autoPlay }},
            plugins: {
                core: [ClapprThumbnailsPlugin, PlaybackRatePlugin]
            },
            scrubThumbnails: {
                backdropHeight: 64,
                spotlightHeight: 84,
                thumbs: thumbnailsSprite()
            },
            playbackRateConfig: {
                defaultValue: '1.0',
                options: [
                    {value: '0.75', label: '0.75x'},
                    {value: '1.0', label: '1x'},
                    {value: '1.25', label: '1.25x'},
                    {value: '1.5', label: '1.5x'},
                    {value: '2.0', label: '2x'}
                ]
            }
        });

        var playerElement = document.getElementById("player-full");
        player.attachTo(playerElement);


        $('#post-title').text(result['title']);
        $('title').text(result['title']);

    };

    // start here
    $(function () {
        getContent();
    });
</script>
</body>
</html>

