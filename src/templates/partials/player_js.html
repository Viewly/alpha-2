<script src="{{ url_for('static', filename='node_modules/clappr/dist/clappr.min.js') }}"></script>
<script src="{{ url_for('static', filename='node_modules/dash-shaka-playback/dist/dash-shaka-playback.min.js') }}"></script>
<script>
    let cdnUrl = "{{ cdn_url() }}";
    let manifestUrl = `${cdnUrl}/v1/{{ video_id }}/manifest.json`;

    let loadManifest = function () {
        fetch(manifestUrl, {
            method: 'get'
        }).then(function (response) {
            response.json().then(manifest => loadPlayer(manifest))
        }).catch(function (err) {
            console.log(err)
        });
    };
    let loadPlayer = function (manifest) {
        let sources = [];

        // todo, check if on safari
        if (manifest.formats['mpeg-dash'] !== 'undefined') {
            sources.push(`${cdnUrl}/${manifest.formats['mpeg-dash']}`)
        }

        if (manifest.formats['fallback'] !== 'undefined') {
            sources.push(`${cdnUrl}/${manifest.formats['fallback']}`)
        }

        let player = new Clappr.Player({
            sources: sources,
            poster: `${cdnUrl}/${manifest.cover}`,
            mute: false,
            height: window.innerHeight - 20,
            width: '100%',
            autoPlay: {{ autoPlay | int }},
            plugins: [
                DashShakaPlayback
            ]
        });
        let playerElement = document.getElementById("player-full");
        player.attachTo(playerElement);
    };

    // start here
    document.addEventListener("DOMContentLoaded", function(event) {
        loadManifest();
    });
</script>

{#<script src="//cdn.jsdelivr.net/clappr.thumbnails-plugin/latest/clappr-thumbnails-plugin.js"></script>#}
{#<script src="{{ url_for('static', filename='js/clappr-playback-rate-plugin.min.js') }}"></script>#}
{#<script>#}
{#    var getContent = function () {#}
{##}
{#            var thumbnailsSprite = function () {#}
{#                // first, we need to find the tilesheet#}
{#                var fileNames = _.map(extractFiles(result['json_metadata']), function (o) {#}
{#                    return o['Name'];#}
{#                });#}
{##}
{#                var spriteFileName = _.first(#}
{#                    _.filter(fileNames, function (filename) {#}
{#                        return /tilesheet_.*\.png/.test(filename)#}
{#                    })#}
{#                );#}
{##}
{#                if (!spriteFileName) {#}
{#                    return []#}
{#                }#}
{##}
{#                var properties = _.tail(spriteFileName.split('.')[0].split('_'));#}
{##}
{#                var numThumbnails = properties[0];#}
{#                var timeInterval = properties[1];#}
{#                var tileWidth = properties[2];#}
{#                var tileHeight = properties[3];#}
{##}
{#                return ClapprThumbnailsPlugin.buildSpriteConfig(#}
{#                    linkBuilder(ipfs_hash, spriteFileName),#}
{#                    numThumbnails,  // number of thumbnails#}
{#                    tileWidth, // thumbnail width#}
{#                    tileHeight, // thumbnail height#}
{#                    10, // number of tiles (columns) per row#}
{#                    timeInterval // time interval#}
{#                );#}
{#            };#}
{##}
{#            var player = new Clappr.Player({#}
{#                source: linkBuilder(ipfs_hash, extractVideoFile(result['json_metadata'])),#}
{#                poster: linkBuilder(ipfs_hash, "thumbnail_1.png"),#}
{#                mute: false,#}
{#                height: window.innerHeight - 20,#}
{#                width: "100%",#}
{#                autoPlay: {{ autoPlay }},#}
{#                plugins: {#}
{#                    core: [ClapprThumbnailsPlugin, PlaybackRatePlugin]#}
{#                },#}
{#                scrubThumbnails: {#}
{#                    backdropHeight: 64,#}
{#                    spotlightHeight: 84,#}
{#                    thumbs: thumbnailsSprite()#}
{#                },#}
{#                playbackRateConfig: {#}
{#                    defaultValue: '1.0',#}
{#                    options: [#}
{#                        {value: '0.5', label: '0.5x'},#}
{#                        {value: '1.0', label: '1x'},#}
{#                        {value: '1.25', label: '1.25x'},#}
{#                        {value: '1.5', label: '1.5x'},#}
{#                        {value: '2.0', label: '2x'}#}
{#                    ]#}
{#                }#}
{#            });#}
{##}
{##}
{#    };#}
{#</script>#}
